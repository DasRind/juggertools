<div class="page">
  <header class="page__header">
    <div class="page__brand">
      <div class="page__logo">
        <img
          src="/tacticslogoNoBackground.png"
          alt="Jugger Tactics Tool"
          class="page__logo-image"
        />
        <img
          src="/tacticslogoIdea.png"
          alt=""
          aria-hidden="true"
          class="page__logo-overlay"
        />
      </div>
      <h1 class="page__title">Jugger Tactics Tool</h1>
      <div class="page__actions">
        <button
          type="button"
          class="theme-toggle"
          (click)="toggleTheme()"
          [attr.aria-pressed]="isDarkMode()"
          aria-label="Darstellung wechseln"
        >
          <span class="theme-toggle__icon" aria-hidden="true"></span>
          <span class="theme-toggle__label">{{ themeToggleLabel() }}</span>
        </button>
      </div>
    </div>
  </header>

  <main class="page__body">
    <div
      class="page__main-row"
      [class.page__main-row--flipped]="isFieldFlipped()"
    >
      <aside class="team-panel team-panel--left">
        <header class="team-panel__header">
          <div class="team-panel__startRow">
            <h2 class="" tea>{{ leftTeam.name }}</h2>
            <div class="team-panel__info"></div>
        </div>
        <div class="team-panel__teamBrand">
          <img class="team-panel__avatar" aria-hidden="true" />
          <div class="team-panel__actions">
            <button type="button">Color 1</button>
            <button type="button">Color 2</button>
          </div>
        </div>
      </header>

      <ul class="player-list">
        <li
          *ngFor="let player of leftPlayers()"
          class="player-card"
          draggable="true"
          (dragstart)="onDragStart($event, player, leftTeam)"
          [class.player-card--active]="playerTokenId(player) === selectedTokenId()"
          [class.player-card--hover]="playerTokenId(player) === hoveredTokenId()"
        >
          <span class="player-card__number">{{ player.number ?? 'â€”' }}</span>
          <div class="player-card__details">
            <span class="player-card__name">{{ player.name }}</span>
            <span class="player-card__role">{{ player.role }}</span>
          </div>
        </li>
      </ul>
    </aside>

    <section
      class="field-area"
      (dragover)="allowDrop($event)"
      [class.field-area--rotated]="isFieldRotated()"
      (drop)="handleDrop($event)"
    >
      <div class="field-area__surface" (wheel)="handleFieldWheel($event)">
        <div class="field-surface__controls">
          <button
            type="button"
            class="field-surface__button"
            (click)="toggleFieldRotation()"
            [attr.aria-pressed]="isFieldRotated()"
            aria-label="Feld um 90Â° drehen"
          >
            âŸ³
          </button>
          <button
            type="button"
            class="field-surface__button field-surface__button--clear"
            (click)="clearField()"
            aria-label="Feld lÃ¶schen"
            title="Feld lÃ¶schen"
          >
            ðŸ—‘
          </button>
        </div>
        <jugger-field
          class="field-component"
          [scene]="scene()"
          [flipHorizontal]="isFieldFlipped()"
          [rotateQuarterTurn]="isFieldRotated()"
          [style.aspect-ratio]="fieldAspectRatio()"
          [zoom]="fieldZoom()"
          [viewportSync]="viewportSyncToken()"
          (engineReady)="handleEngineReady($event)"
          (viewportChange)="handleViewportChange($event)"
          (pointerDown)="handlePointer($event)"
          (pointerMove)="handlePointer($event)"
          (pointerUp)="handlePointer($event)"
          (pointerCancel)="handlePointer($event)"
        ></jugger-field>
      </div>

      <div class="page__stack">
        <div class="field-status">
          <ng-container *ngIf="selectedStatus() as selection; else fieldStatusTool">
            <div class="field-status__section field-status__primary field-status__selection">
              <div class="field-status__info">
                <span class="field-status__label">Auswahl</span>
                <span class="field-status__value">{{ selection.label }}</span>
              </div>
              <div class="field-status__actions">
                <div class="field-status__colors" *ngIf="selection.supportsColor">
                  <button
                    type="button"
                    class="field-status__color-button"
                    [style.background-color]="selection.color ?? '#f8fafc'"
                    (click)="toggleColorMenu('selection')"
                    aria-label="Farbe Ã¤ndern"
                  >
                    <span class="sr-only">Aktuelle Farbe Ã¤ndern</span>
                  </button>
                  <div
                    class="field-status__color-menu"
                    *ngIf="isSelectionColorMenuOpen()"
                  >
                    <div class="field-status__swatches">
                      <button
                        type="button"
                        *ngFor="let color of selection.palette"
                        class="field-status__swatch"
                        [class.field-status__swatch--active]="selection.color && selection.color.toLowerCase() === color.toLowerCase()"
                        [style.background-color]="color"
                        (click)="applySelectedColor(color)"
                        [attr.aria-label]="'Farbe ' + color"
                      ></button>
                    </div>
                    <label class="field-status__custom">
                      Eigene Farbe
                      <input
                        type="color"
                        [value]="selection.color || '#ffffff'"
                        (input)="applyCustomColor($event, 'selection')"
                      />
                    </label>
                  </div>
                </div>
                <button
                  type="button"
                  class="field-status__delete"
                  (click)="deleteSelectedElement()"
                  aria-label="Auswahl entfernen"
                >
                  Ã—
                </button>
              </div>
              <label
                *ngIf="selection.type === 'token'"
                class="field-status__slider"
              >
                <span>
                  Token-GrÃ¶ÃŸe
                  <small>{{ tokenScaleLabel() }}</small>
                </span>
                <input
                  #tokenSizeSelection
                  type="range"
                  [min]="tokenScaleMin"
                  [max]="tokenScaleMax"
                  step="0.05"
                  [value]="tokenScale()"
                  (input)="changeTokenScale(tokenSizeSelection.value)"
                />
              </label>
            </div>
          </ng-container>
          <ng-template #fieldStatusTool>
            <ng-container *ngIf="toolStatus() as tool">
              <div class="field-status__section field-status__primary field-status__tool">
                <div class="field-status__info">
                  <span class="field-status__label">Tool</span>
                  <span class="field-status__value">{{ tool.label }}</span>
                </div>
                <div class="field-status__tool-content" [ngSwitch]="tool.kind">
                  <div *ngSwitchCase="'pen'">
                    <div class="field-status__actions">
                      <div class="field-status__colors">
                        <button
                          type="button"
                          class="field-status__color-button"
                          [style.background-color]="tool.color"
                          (click)="toggleColorMenu('pen')"
                          aria-label="Stiftfarbe Ã¤ndern"
                        >
                          <span class="sr-only">Stiftfarbe Ã¤ndern</span>
                        </button>
                        <div
                          class="field-status__color-menu"
                          *ngIf="openToolColorMenu() === 'pen'"
                        >
                          <div class="field-status__swatches">
                            <button
                              type="button"
                              *ngFor="let color of tool.palette || []"
                              class="field-status__swatch"
                              [class.field-status__swatch--active]="tool.color && tool.color.toLowerCase() === color.toLowerCase()"
                              [style.background-color]="color"
                              (click)="applyToolColor('pen', color)"
                              [attr.aria-label]="'Farbe ' + color"
                            ></button>
                          </div>
                          <label class="field-status__custom">
                            Eigene Farbe
                            <input
                              type="color"
                              [value]="tool.color || '#ffffff'"
                              (input)="applyCustomColor($event, 'pen')"
                            />
                          </label>
                        </div>
                      </div>
                    </div>
                    <label class="field-status__slider">
                      <span>
                        StrichstÃ¤rke
                        <small>{{ strokeWidthFactorLabel() }}</small>
                      </span>
                      <input
                        #penWidthSlider
                        type="range"
                        [min]="strokeFactorMin"
                        [max]="strokeFactorMax"
                        step="0.05"
                        [value]="strokeWidthFactor()"
                        (input)="changeStrokeWidthFactor(penWidthSlider.value)"
                      />
                    </label>
                  </div>

                  <div *ngSwitchCase="'arrow'">
                    <div class="field-status__actions">
                      <div class="field-status__colors">
                        <button
                          type="button"
                          class="field-status__color-button"
                          [style.background-color]="tool.color"
                          (click)="toggleColorMenu('arrow')"
                          aria-label="Pfeilfarbe Ã¤ndern"
                        >
                          <span class="sr-only">Pfeilfarbe Ã¤ndern</span>
                        </button>
                        <div
                          class="field-status__color-menu"
                          *ngIf="openToolColorMenu() === 'arrow'"
                        >
                          <div class="field-status__swatches">
                            <button
                              type="button"
                              *ngFor="let color of tool.palette || []"
                              class="field-status__swatch"
                              [class.field-status__swatch--active]="tool.color && tool.color.toLowerCase() === color.toLowerCase()"
                              [style.background-color]="color"
                              (click)="applyToolColor('arrow', color)"
                              [attr.aria-label]="'Farbe ' + color"
                            ></button>
                          </div>
                          <label class="field-status__custom">
                            Eigene Farbe
                            <input
                              type="color"
                              [value]="tool.color || '#ffffff'"
                              (input)="applyCustomColor($event, 'arrow')"
                            />
                          </label>
                        </div>
                      </div>
                    </div>
                    <label class="field-status__slider">
                      <span>
                        StrichstÃ¤rke
                        <small>{{ strokeWidthFactorLabel() }}</small>
                      </span>
                      <input
                        #arrowWidthSlider
                        type="range"
                        [min]="strokeFactorMin"
                        [max]="strokeFactorMax"
                        step="0.05"
                        [value]="strokeWidthFactor()"
                        (input)="changeStrokeWidthFactor(arrowWidthSlider.value)"
                      />
                    </label>
                  </div>

                  <div *ngSwitchCase="'eraser'">
                    <label class="field-status__slider">
                      <span>
                        Radius
                        <small>{{ eraserRadiusLabel() }}</small>
                      </span>
                      <input
                        #eraserRadiusSlider
                        type="range"
                        [min]="eraserRadiusMin"
                        [max]="eraserRadiusMax"
                        step="1"
                        [value]="eraserRadius()"
                        (input)="changeEraserRadius(eraserRadiusSlider.value)"
                      />
                    </label>
                  </div>
                </div>
              </div>
            </ng-container>
          </ng-template>

          <!-- field controls moved to canvas surface -->
        </div>

        <section
          class="collapsible collapsible--tools"
          [class.collapsible--open]="showToolsPanel()"
        >
          <button
            type="button"
            class="collapsible__header"
            (click)="toggleToolsPanel()"
            [attr.aria-expanded]="showToolsPanel()"
          >
            <span class="collapsible__label">Werkzeuge</span>
            <span
              class="collapsible__chevron"
              [class.collapsible__chevron--open]="showToolsPanel()"
              aria-hidden="true"
            >
              â–¾
            </span>
          </button>
          <div class="collapsible__body" *ngIf="showToolsPanel()">
            <div class="tool-buttons">
              <div class="tool-buttons__item" *ngFor="let tool of toolShortcuts">
                <span
                  class="tool-buttons__shortcut"
                  [class.tool-buttons__shortcut--active]="tool.id === selectedTool()"
                >
                  {{ tool.shortcut }}
                </span>
                <button
                  type="button"
                  class="tool-button"
                  [class.tool-button--active]="tool.id === selectedTool()"
                  (click)="selectTool(tool.id)"
                >
                  <span class="tool-button__label">{{ tool.label }}</span>
                </button>
              </div>
            </div>
          </div>
        </section>

        <section
          class="collapsible collapsible--animation"
          [class.collapsible--open]="showAnimationPanel()"
        >
          <button
            type="button"
            class="collapsible__header"
            (click)="toggleAnimationPanel()"
            [attr.aria-expanded]="showAnimationPanel()"
          >
            <span class="collapsible__label">Animation</span>
            <span
              class="collapsible__chevron"
              [class.collapsible__chevron--open]="showAnimationPanel()"
              aria-hidden="true"
            >
              â–¾
            </span>
          </button>
          <div class="collapsible__body" *ngIf="showAnimationPanel()">
            <div class="scene-strip" role="tablist" aria-label="Szenen">
              <div class="scene-strip__list">
                <div
                  class="scene-strip__item"
                  *ngFor="let item of scenes(); trackBy: trackScene"
                  [class.scene-strip__item--active]="item.id === activeSceneIdValue()"
                >
                  <button
                    type="button"
                    class="scene-strip__select"
                    (click)="activateScene(item.id)"
                    role="tab"
                    [attr.aria-selected]="item.id === activeSceneIdValue()"
                  >
                    <div
                      class="scene-strip__thumbnail"
                      [class.scene-strip__thumbnail--empty]="!item.previewDataUrl"
                      [style.background-image]="item.previewDataUrl ? 'url(' + item.previewDataUrl + ')' : ''"
                    ></div>
                    <div class="scene-strip__meta">
                      <span class="scene-strip__label">{{ item.label }}</span>
                      <span class="scene-strip__time"
                        >{{ item.updatedAt | date: 'HH:mm' }}</span
                      >
                    </div>
                  </button>
                  <button
                    type="button"
                    class="scene-strip__delete"
                    (click)="deleteScene(item.id); $event.stopPropagation()"
                    [disabled]="scenes().length <= 1"
                    aria-label="Szene entfernen"
                    title="Szene entfernen"
                  >
                    Ã—
                  </button>
                </div>
              </div>
              <button
                type="button"
                class="scene-strip__add"
                (click)="addScene()"
                aria-label="Neue Szene hinzufÃ¼gen"
              >
                <span aria-hidden="true">+</span>
              </button>
            </div>
          </div>
        </section>

        <section
            class="collapsible field-footer__panel"
            [class.collapsible--open]="showAdvancedPanel()"
          >
            <button
              type="button"
              class="collapsible__header"
              (click)="toggleAdvancedPanel()"
              [attr.aria-expanded]="showAdvancedPanel()"
            >
              <span class="collapsible__label">Erweiterte Einstellungen</span>
              <span
                class="collapsible__chevron"
                [class.collapsible__chevron--open]="showAdvancedPanel()"
                aria-hidden="true"
              >
                â–¾
              </span>
            </button>
            <div class="collapsible__body" *ngIf="showAdvancedPanel()">
              <div class="field-footer__advanced">
                <div class="field-area__toggles">
                  <button
                    type="button"
                    class="toggle-button"
                    [class.toggle-button--active]="showPlayerNames()"
                    (click)="togglePlayerNames()"
                  >
                    <span class="toggle-button__label">Spieler Namen:</span>
                    <span class="toggle-button__value"
                      >{{ playerNameToggleLabel() }}</span
                    >
                  </button>
                  <button
                    type="button"
                    class="toggle-button"
                    [class.toggle-button--active]="showStartingPositions()"
                    (click)="toggleStartingPositions()"
                  >
                    <span class="toggle-button__label">Startpositionen:</span>
                    <span class="toggle-button__value"
                      >{{ startingPositionsToggleLabel() }}</span
                    >
                  </button>
                  <button
                    type="button"
                    class="toggle-button"
                    [class.toggle-button--active]="hasJugg()"
                    (click)="spawnJugg()"
                  >
                    <span class="toggle-button__label">Jugg:</span>
                    <span class="toggle-button__value"
                      >{{ hasJugg() ? 'Neu zentrieren' : 'Platzieren' }}</span
                    >
                  </button>
                  <div
                    class="field-settings"
                    [class.field-settings--open]="showFieldSettings()"
                  >
                    <button
                      type="button"
                      class="toggle-button field-settings__toggle"
                      [class.toggle-button--active]="showFieldSettings()"
                      (click)="toggleFieldSettings()"
                    >
                      <span class="toggle-button__label">Feld:</span>
                      <span class="toggle-button__value">Einstellungen</span>
                    </button>
                    <div *ngIf="showFieldSettings()" class="field-settings__dropdown">
                      <div class="field-settings__group">
                        <span class="field-settings__heading">Farben</span>
                        <label class="field-settings__option">
                          <span>FeldflÃ¤che</span>
                          <input
                            #surfaceColorPicker
                            type="color"
                            [value]="fieldSurfaceColor()"
                            (input)="updateFieldSurfaceColor(surfaceColorPicker.value)"
                          />
                        </label>
                        <label class="field-settings__option">
                          <span>Linien</span>
                          <input
                            #lineColorPicker
                            type="color"
                            [value]="fieldLineColor()"
                            (input)="updateFieldLineColor(lineColorPicker.value)"
                          />
                        </label>
                        <label class="field-settings__option">
                          <span>Umrandung</span>
                          <input
                            #borderColorPicker
                            type="color"
                            [value]="fieldBoundaryColor()"
                            (input)="updateFieldBoundaryColor(borderColorPicker.value)"
                          />
                        </label>
                      </div>
                    </div>
                  </div>
                </div>

                <div class="field-area__history history-indicator">
                  <div class="history-indicator__row">
                    <span>Undo</span>
                    <div class="history-indicator__bar">
                      <div
                        class="history-indicator__fill"
                        [style.width.%]="undoFill()"
                      ></div>
                    </div>
                    <span>{{ undoDepth() }}/{{ historyCapacity }}</span>
                  </div>
                  <div class="history-indicator__row">
                    <span>Redo</span>
                    <div class="history-indicator__bar">
                      <div
                        class="history-indicator__fill history-indicator__fill--redo"
                        [style.width.%]="redoFill()"
                      ></div>
                    </div>
                    <span>{{ redoDepth() }}/{{ historyCapacity }}</span>
                  </div>
                </div>

                <div class="field-area__actions field-area__actions--undo">
                  <button type="button" (click)="undo()" [disabled]="!canUndo()">
                    Undo ({{ undoDepth() }})
                  </button>
                  <button type="button" (click)="redo()" [disabled]="!canRedo()">
                    Redo ({{ redoDepth() }})
                  </button>
                </div>
              </div>
            </div>
          </section>

          <section
            class="collapsible field-footer__panel"
            [class.collapsible--open]="showExportPanel()"
          >
            <button
              type="button"
              class="collapsible__header"
              (click)="toggleExportPanel()"
              [attr.aria-expanded]="showExportPanel()"
            >
              <span class="collapsible__label">Export</span>
              <span
                class="collapsible__chevron"
                [class.collapsible__chevron--open]="showExportPanel()"
                aria-hidden="true"
              >
                â–¾
              </span>
            </button>
            <div class="collapsible__body" *ngIf="showExportPanel()">
              <div class="field-footer__export">
                <input
                  #importJsonInput
                  type="file"
                  accept="application/json"
                  class="field-area__import-input"
                  (change)="importJson($event)"
                />
                <div class="field-area__actions field-area__actions--export">
                  <button
                    type="button"
                    class="field-area__export"
                    (click)="triggerImportJson(importJsonInput)"
                  >
                    Import JSON
                  </button>
                  <button
                    type="button"
                    class="field-area__export"
                    (click)="exportJson()"
                  >
                    Export JSON
                  </button>
                  <label class="field-area__resolution">
                    <span class="field-area__resolution-label">AuflÃ¶sung</span>
                    <select
                      #resolutionSelect
                      class="field-area__resolution-select"
                      [value]="selectedExportResolution()"
                      (change)="setExportResolution(resolutionSelect.value)"
                    >
                      <option
                        *ngFor="let option of exportResolutions"
                        [value]="option.id"
                      >
                        {{ option.label }}
                      </option>
                    </select>
                  </label>
                  <label class="field-area__resolution">
                    <span class="field-area__resolution-label">Format</span>
                    <select
                      #animationFormatSelect
                      class="field-area__resolution-select"
                      [value]="selectedAnimationFormat()"
                      (change)="setAnimationFormat(animationFormatSelect.value)"
                    >
                      <option
                        *ngFor="let option of animationFormats"
                        [value]="option.id"
                      >
                        {{ option.label }}
                      </option>
                    </select>
                  </label>
                  <label class="field-area__resolution">
                    <span class="field-area__resolution-label">Dauer pro Szene</span>
                    <select
                      #animationDurationSelect
                      class="field-area__resolution-select"
                      [value]="selectedAnimationDuration()"
                      (change)="setAnimationDuration(animationDurationSelect.value)"
                    >
                      <option
                        *ngFor="let option of animationDurations"
                        [value]="option.id"
                      >
                        {{ option.label }}
                      </option>
                    </select>
                  </label>
                  <button
                    type="button"
                    class="field-area__export"
                    (click)="exportScreenshot()"
                  >
                    Export PNG
                  </button>
                  <button
                    type="button"
                    class="field-area__export"
                    (click)="exportAnimation()"
                    [disabled]="!canExportAnimation() || isAnimationExporting()"
                  >
                    <ng-container *ngIf="!isAnimationExporting(); else exportingAnimation">
                      Export Animation
                    </ng-container>
                    <ng-template #exportingAnimation>
                      <span class="field-area__exporting">
                        <span class="field-area__spinner" aria-hidden="true"></span>
                        {{ animationProgress()?.message ?? 'Export lÃ¤uft â€¦' }}
                      </span>
                    </ng-template>
                  </button>
                </div>
              </div>
            </div>
          </section>

          <p class="field-area__pointer" *ngIf="lastPointerEvent() as pointer">
            Letztes Event: {{ pointer }}
          </p>
      </div>
    </section>


    <aside class="team-panel team-panel--right">
      <header class="team-panel__header">
        <div class="team-panel__info team-panel__info--right">
          <div class="team-panel__startRow">
            <h2>{{ rightTeam.name }}</h2>
          </div>
        </div>
        <div class="team-panel__teamBrand">
          <div class="team-panel__actions">
            <button type="button">Color 1</button>
            <button type="button">Color 2</button>
          </div>
          <div class="team-panel__avatar" aria-hidden="true"></div>
        </div>
      </header>

      <ul class="player-list">
        <li
          *ngFor="let player of rightPlayers()"
          class="player-card"
          draggable="true"
          (dragstart)="onDragStart($event, player, rightTeam)"
          [class.player-card--active]="playerTokenId(player) === selectedTokenId()"
          [class.player-card--hover]="playerTokenId(player) === hoveredTokenId()"
        >
          <span class="player-card__number">{{ player.number ?? 'â€”' }}</span>
          <div class="player-card__details">
            <span class="player-card__name">{{ player.name }}</span>
            <span class="player-card__role">{{ player.role }}</span>
          </div>
        </li>
      </ul>
    </aside>
    </div>

  </main>
</div>

<div
  class="toast"
  *ngIf="toast() as toast"
  [class.toast--warning]="toast.intent === 'warning'"
  [class.toast--error]="toast.intent === 'error'"
>
  <span>{{ toast.message }}</span>
  <div class="toast__actions" *ngIf="toast.actions?.length">
    <button
      type="button"
      *ngFor="let action of toast.actions"
      (click)="onToastAction(toast, action)"
    >
      {{ action.label }}
    </button>
  </div>
</div>
