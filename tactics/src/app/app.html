<div class="page">
  <header class="page__header">
    <h1 class="page__title">Jugger Tactics Tool</h1>
    <div class="page__toolbar">
      <div class="tool-buttons">
        <div class="tool-buttons__item" *ngFor="let tool of toolShortcuts">
          <span
            class="tool-buttons__shortcut"
            [class.tool-buttons__shortcut--active]="tool.id === selectedTool()"
          >
            {{ tool.shortcut }}
          </span>
          <button
            type="button"
            class="tool-button"
            [class.tool-button--active]="tool.id === selectedTool()"
            (click)="selectTool(tool.id)"
          >
            <span class="tool-button__label">{{ tool.label }}</span>
          </button>
        </div>
      </div>
    </div>
  </header>

  <main class="page__body">
    <aside class="team-panel team-panel--left">
      <header class="team-panel__header">
        <div class="team-panel__startRow">
          <h2 class="" tea>{{ leftTeam.name }}</h2>
          <div class="team-panel__info"></div>
        </div>
        <div class="team-panel__teamBrand">
          <img class="team-panel__avatar" aria-hidden="true" />
          <div class="team-panel__actions">
            <button type="button">Color 1</button>
            <button type="button">Color 2</button>
          </div>
        </div>
      </header>

      <ul class="player-list">
        <li
          *ngFor="let player of leftPlayers()"
          class="player-card"
          draggable="true"
          (dragstart)="onDragStart($event, player, leftTeam)"
          [class.player-card--active]="playerTokenId(player) === selectedTokenId()"
          [class.player-card--hover]="playerTokenId(player) === hoveredTokenId()"
        >
          <span class="player-card__number">{{ player.number ?? '—' }}</span>
          <div class="player-card__details">
            <span class="player-card__name">{{ player.name }}</span>
            <span class="player-card__role">{{ player.role }}</span>
          </div>
        </li>
      </ul>
    </aside>

    <section
      class="field-area"
      (dragover)="allowDrop($event)"
      (drop)="handleDrop($event)"
    >
      <div class="field-area__surface">
        <div class="field-status">
          <div class="field-status__section field-status__selection">
            <ng-container
              *ngIf="selectedStatus() as selection; else noSelection"
            >
              <div class="field-status__info">
                <span class="field-status__label">Auswahl</span>
                <span class="field-status__value">{{ selection.label }}</span>
              </div>
              <div class="field-status__actions">
                <div
                  class="field-status__colors"
                  *ngIf="selection.supportsColor"
                >
                  <button
                    type="button"
                    class="field-status__color-button"
                    [style.background-color]="selection.color ?? '#f8fafc'"
                    (click)="toggleColorMenu('selection')"
                    aria-label="Farbe ändern"
                  >
                    <span class="sr-only">Aktuelle Farbe ändern</span>
                  </button>
                  <div
                    class="field-status__color-menu"
                    *ngIf="isSelectionColorMenuOpen()"
                  >
                    <div class="field-status__swatches">
                      <button
                        type="button"
                        *ngFor="let color of selection.palette"
                        class="field-status__swatch"
                        [class.field-status__swatch--active]="selection.color && selection.color.toLowerCase() === color.toLowerCase()"
                        [style.background-color]="color"
                        (click)="applySelectedColor(color)"
                        [attr.aria-label]="'Farbe ' + color"
                      ></button>
                    </div>
                    <label class="field-status__custom">
                      Eigene Farbe
                      <input
                        type="color"
                        [value]="selection.color || '#ffffff'"
                        (input)="applyCustomColor($event, 'selection')"
                      />
                    </label>
                  </div>
                </div>
                <button
                  type="button"
                  class="field-status__delete"
                  (click)="deleteSelectedElement()"
                  aria-label="Auswahl entfernen"
                >
                  ×
                </button>
              </div>
            </ng-container>
            <ng-template #noSelection>
              <div class="field-status__info field-status__info--empty">
                <span class="field-status__label">Auswahl</span>
                <span class="field-status__value field-status__value--empty"
                  >Keine</span
                >
              </div>
            </ng-template>
          </div>

          <div
            class="field-status__section field-status__tool"
            *ngIf="toolStatus() as tool"
          >
            <ng-container [ngSwitch]="tool.kind">
              <div *ngSwitchCase="'pen'" class="field-status__tool-content">
                <span class="field-status__label">{{ tool.label }}</span>
                <div class="field-status__actions">
                  <div class="field-status__colors">
                    <button
                      type="button"
                      class="field-status__color-button"
                      [style.background-color]="tool.color"
                      (click)="toggleColorMenu('pen')"
                      aria-label="Stiftfarbe ändern"
                    >
                      <span class="sr-only">Stiftfarbe ändern</span>
                    </button>
                    <div
                      class="field-status__color-menu"
                      *ngIf="openToolColorMenu() === 'pen'"
                    >
                      <div class="field-status__swatches">
                        <button
                          type="button"
                          *ngFor="let color of tool.palette || []"
                          class="field-status__swatch"
                          [class.field-status__swatch--active]="tool.color && tool.color.toLowerCase() === color.toLowerCase()"
                          [style.background-color]="color"
                          (click)="applyToolColor('pen', color)"
                          [attr.aria-label]="'Farbe ' + color"
                        ></button>
                      </div>
                      <label class="field-status__custom">
                        Eigene Farbe
                        <input
                          type="color"
                          [value]="tool.color || '#ffffff'"
                          (input)="applyCustomColor($event, 'pen')"
                        />
                      </label>
                    </div>
                  </div>
                </div>
              </div>

              <div *ngSwitchCase="'arrow'" class="field-status__tool-content">
                <span class="field-status__label">{{ tool.label }}</span>
                <div class="field-status__actions">
                  <div class="field-status__colors">
                    <button
                      type="button"
                      class="field-status__color-button"
                      [style.background-color]="tool.color"
                      (click)="toggleColorMenu('arrow')"
                      aria-label="Pfeilfarbe ändern"
                    >
                      <span class="sr-only">Pfeilfarbe ändern</span>
                    </button>
                    <div
                      class="field-status__color-menu"
                      *ngIf="openToolColorMenu() === 'arrow'"
                    >
                      <div class="field-status__swatches">
                        <button
                          type="button"
                          *ngFor="let color of tool.palette || []"
                          class="field-status__swatch"
                          [class.field-status__swatch--active]="tool.color && tool.color.toLowerCase() === color.toLowerCase()"
                          [style.background-color]="color"
                          (click)="applyToolColor('arrow', color)"
                          [attr.aria-label]="'Farbe ' + color"
                        ></button>
                      </div>
                      <label class="field-status__custom">
                        Eigene Farbe
                        <input
                          type="color"
                          [value]="tool.color || '#ffffff'"
                          (input)="applyCustomColor($event, 'arrow')"
                        />
                      </label>
                    </div>
                  </div>
                </div>
              </div>

              <div *ngSwitchCase="'eraser'" class="field-status__tool-content">
                <span class="field-status__label">{{ tool.label }}</span>
                <div class="field-status__eraser-options">
                  <button
                    *ngFor="let option of tool.sizes || []"
                    type="button"
                    class="field-status__eraser-button"
                    [class.field-status__eraser-button--active]="option.id === tool.selectedSize"
                    (click)="selectEraserSize(option.id)"
                  >
                    {{ option.label }}
                  </button>
                </div>
              </div>
            </ng-container>
          </div>

          <div class="field-status__section field-status__flip-section">
            <button
              type="button"
              class="field-status__flip"
              (click)="toggleFieldFlip()"
              [attr.aria-pressed]="isFieldFlipped()"
              aria-label="Feld spiegeln"
            >
              ⇄
            </button>
          </div>
        </div>
        <jugger-field
          class="field-component"
          [scene]="scene()"
          [flipHorizontal]="isFieldFlipped()"
          (engineReady)="handleEngineReady($event)"
          (viewportChange)="handleViewportChange($event)"
          (pointerDown)="handlePointer($event)"
          (pointerMove)="handlePointer($event)"
          (pointerUp)="handlePointer($event)"
          (pointerCancel)="handlePointer($event)"
        ></jugger-field>
      </div>

      <footer class="field-area__footer">
        <div class="field-area__control-row">
          <input
            #importJsonInput
            type="file"
            accept="application/json"
            class="field-area__import-input"
            (change)="importJson($event)"
          />
          <div class="field-area__toggles">
            <button
              type="button"
              class="toggle-button"
              [class.toggle-button--active]="showPlayerNames()"
              (click)="togglePlayerNames()"
            >
              <span class="toggle-button__label">Spieler Namen:</span>
              <span class="toggle-button__value"
                >{{ playerNameToggleLabel() }}</span
              >
            </button>
            <button
              type="button"
              class="toggle-button"
              [class.toggle-button--active]="showStartingPositions()"
              (click)="toggleStartingPositions()"
            >
              <span class="toggle-button__label">Startpositionen:</span>
              <span class="toggle-button__value"
                >{{ startingPositionsToggleLabel() }}</span
              >
            </button>
            <button
              type="button"
              class="toggle-button"
              [class.toggle-button--active]="hasJugg()"
              (click)="spawnJugg()"
            >
              <span class="toggle-button__label">Jugg:</span>
              <span class="toggle-button__value"
                >{{ hasJugg() ? 'Neu zentrieren' : 'Platzieren' }}</span
              >
            </button>
          </div>

          <div class="field-area__history history-indicator">
            <div class="history-indicator__row">
              <span>Undo</span>
              <div class="history-indicator__bar">
                <div
                  class="history-indicator__fill"
                  [style.width.%]="undoFill()"
                ></div>
              </div>
              <span>{{ undoDepth() }}/{{ historyCapacity }}</span>
            </div>
            <div class="history-indicator__row">
              <span>Redo</span>
              <div class="history-indicator__bar">
                <div
                  class="history-indicator__fill history-indicator__fill--redo"
                  [style.width.%]="redoFill()"
                ></div>
              </div>
              <span>{{ redoDepth() }}/{{ historyCapacity }}</span>
            </div>
          </div>

          <div class="field-area__actions">
            <button type="button" (click)="undo()" [disabled]="!canUndo()">
              Undo ({{ undoDepth() }})
            </button>
            <button type="button" (click)="redo()" [disabled]="!canRedo()">
              Redo ({{ redoDepth() }})
            </button>
            <button
              type="button"
              class="field-area__export"
              (click)="triggerImportJson(importJsonInput)"
            >
              Import JSON
            </button>
            <button
              type="button"
              class="field-area__export"
              (click)="exportJson()"
            >
              Export JSON
            </button>
            <label class="field-area__resolution">
              <span class="field-area__resolution-label">Auflösung</span>
              <select
                #resolutionSelect
                class="field-area__resolution-select"
                [value]="selectedExportResolution()"
                (change)="setExportResolution(resolutionSelect.value)"
              >
                <option
                  *ngFor="let option of exportResolutions"
                  [value]="option.id"
                >
                  {{ option.label }}
                </option>
              </select>
            </label>
            <button
              type="button"
              class="field-area__export"
              (click)="exportScreenshot()"
            >
              Export PNG
            </button>
          </div>
        </div>

        <p class="field-area__pointer" *ngIf="lastPointerEvent() as pointer">
          Letztes Event: {{ pointer }}
        </p>
      </footer>
    </section>

    <aside class="team-panel team-panel--right">
      <header class="team-panel__header">
        <div class="team-panel__info team-panel__info--right">
          <div class="team-panel__startRow">
            <h2>{{ rightTeam.name }}</h2>
          </div>
        </div>
        <div class="team-panel__teamBrand">
          <div class="team-panel__actions">
            <button type="button">Color 1</button>
            <button type="button">Color 2</button>
          </div>
          <div class="team-panel__avatar" aria-hidden="true"></div>
        </div>
      </header>

      <ul class="player-list">
        <li
          *ngFor="let player of rightPlayers()"
          class="player-card"
          draggable="true"
          (dragstart)="onDragStart($event, player, rightTeam)"
          [class.player-card--active]="playerTokenId(player) === selectedTokenId()"
          [class.player-card--hover]="playerTokenId(player) === hoveredTokenId()"
        >
          <span class="player-card__number">{{ player.number ?? '—' }}</span>
          <div class="player-card__details">
            <span class="player-card__name">{{ player.name }}</span>
            <span class="player-card__role">{{ player.role }}</span>
          </div>
        </li>
      </ul>
    </aside>
  </main>
</div>

<div
  class="toast"
  *ngIf="toast() as toast"
  [class.toast--warning]="toast.intent === 'warning'"
  [class.toast--error]="toast.intent === 'error'"
>
  <span>{{ toast.message }}</span>
  <div class="toast__actions" *ngIf="toast.actions?.length">
    <button
      type="button"
      *ngFor="let action of toast.actions"
      (click)="onToastAction(toast, action)"
    >
      {{ action.label }}
    </button>
  </div>
</div>
